"""
This script can be used to create a new experiment directory. It will
have a name of the form: <N>-<two>-<words> where <N> is the number of
experiments in the directory, and and "<two>-<words>" is a random name
or slug generated by the `coolname` package.
"""

import re
import sys
from pathlib import Path

from coolname import generate_slug


def get_arguments() -> Path:
    """
    Get the `base_dir` from the command line arguments.
    """

    if len(sys.argv) == 1:
        base_dir = Path.cwd()

    elif len(sys.argv) == 2:

        # Check if we are asking for help
        if sys.argv[1] in ["-h", "--help"]:
            print("Usage: nex [base_dir]")
            sys.exit(0)

        # Otherwise, use the command line argument as the base directory
        base_dir = Path(sys.argv[1])
        if not base_dir.is_dir():
            print(f"The given base directory '{base_dir}' does not exist!")
            sys.exit(1)

    else:
        print("Too many command line arguments! See --help for usage.")
        sys.exit(1)

    return base_dir


def create_experiment_dir(
    base_dir: Path | None = None,
    verbose: bool = True,
) -> Path:
    """
    Function to create a new experiment directory in the given
    `base_dir` directory. If no `base_dir` is given, the function
    will try to get it from the command line arguments.
    This function can be used as an entry point for the `nex` command.
    """

    # Check if we got a base dir or if we need to get it from the command line
    if base_dir is None:
        base_dir = get_arguments()

    # Check if there are any experiments in the directory that follow our
    # naming convention; if not, we can simply create a new directory;
    # otherwise, we need to find the highest number and increment it by 1.
    # This works even if there are gaps in the numbering (e.g., because we
    # deleted some failed experiments).
    existing_experiments = list(
        filter(
            lambda x: (
                x.is_dir()
                and re.match(r"^\d{3}-[a-z]+-[a-z]+$", x.name)
            ),
            base_dir.glob("*")
        )
    )
    if not existing_experiments:
        n = 1
    else:
        n = max(map(lambda x: int(x.name[:3]), existing_experiments)) + 1

    # Generate a random name for the new experiment directory
    slug = generate_slug(2)
    name = f"{n:03d}-{slug}"

    # Create the new experiment directory
    experiment_dir = base_dir / name
    experiment_dir.mkdir()

    # Print the path to the new experiment directory
    if verbose:
        print("Created new experiment directory:", experiment_dir.resolve())

    return experiment_dir
